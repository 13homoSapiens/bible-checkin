import re
from typing import Dict, List, Optional

bible_books_flat = [
    '创世记','創世記','创','創',
    '出埃及记','出埃及記','出',
    '利未记','利未記','利',
    '民数记','民數記','民',
    '申命记','申命記','申',
    '约书亚记','約書亞記','书','書',
    '士师记','士師記','士',
    '路得记','路得記','得',
    '撒母耳记上','撒母耳記上','撒上',
    '撒母耳记下','撒母耳記下','撒下',
    '列王纪上','列王紀上','王上',
    '列王纪下','列王紀下','王下',
    '历代志上','歷代志上','代上',
    '历代志下','歷代志下','代下',
    '以斯拉记','以斯拉記','拉',
    '尼希米记','尼希米記','尼',
    '以斯帖记','以斯帖記','斯',
    '约伯记','約伯記','伯',
    '诗篇','詩篇','诗','詩',
    '箴言','箴言','箴',
    '传道书','傳道書','传','傳',
    '雅歌','雅歌','歌',
    '以赛亚书','以賽亞書','赛','賽',
    '耶利米书','耶利米書','耶',
    '耶利米哀歌','耶利米哀歌','哀',
    '以西结书','以西結書','结','結',
    '但以理书','但以理書','但',
    '何西阿书','何西阿書','何',
    '约珥书','約珥書','珥',
    '阿摩司书','阿摩司書','摩',
    '俄巴底亚书','俄巴底亞書','俄',
    '约拿书','約拿書','拿',
    '弥迦书','彌迦書','弥','彌',
    '那鸿书','那鴻書','鸿','鴻',
    '哈巴谷书','哈巴谷書','哈',
    '西番雅书','西番雅書','番',
    '哈该书','哈該書','该','該',
    '撒迦利亚书','撒迦利亞書','亚','亞',
    '玛拉基书','瑪拉基書','玛','瑪',
    '马太福音','馬太福音','太',
    '马可福音','馬可福音','可',
    '路加福音','路加福音','路',
    '约翰福音','約翰福音','约','約',
    '使徒行传','使徒行傳','徒',
    '罗马书','羅馬書','罗','羅',
    '哥林多前书','哥林多前書','林前',
    '哥林多后书','哥林多後書','林后','林後',
    '加拉太书','加拉太書','加',
    '以弗所书','以弗所書','弗',
    '腓立比书','腓立比書','腓',
    '歌罗西书','歌羅西書','西',
    '帖撒罗尼迦前书','帖撒羅尼迦前書','帖前',
    '帖撒罗尼迦后书','帖撒羅尼迦後書','帖后','帖後',
    '提摩太前书','提摩太前書','提前',
    '提摩太后书','提摩太後書','提后','提後',
    '提多书','提多書','多',
    '腓利门书','腓利門書','门','門',
    '希伯来书','希伯來書','来','來',
    '雅各书','雅各書','雅',
    '彼得前书','彼得前書','彼前',
    '彼得后书','彼得後書','彼后','彼後',
    '约翰一书','約翰一書','约一','約一',
    '约翰二书','約翰二書','约二','約二',
    '约翰三书','約翰三書','约三','約三',
    '犹大书','猶大書','犹','猶',
    '启示录','啟示錄','启','啟'
]

# 按长度排序（避免短书名抢匹配）
bible_books_sorted = sorted(bible_books_flat, key=len, reverse=True)


def extract_book_and_chapter(text: str):
    for book in bible_books_sorted:
        if book in text:
            # 在书名后面抓章节
            pattern = re.escape(book) + r'\s*第?\s*(\d+(?:[-–—]\d+)?)\s*章?'
            m = re.search(pattern, text)
            if m:
                chapters = m.group(1).replace('–', '-').replace('—', '-')
                return book, chapters
    return None, None


def parse_checkin(text: str) -> Dict[str, Optional[object]]:

    # -------- 日期（只保留 M月D日）--------
    m = re.search(r'(?:\d{4}\s*年\s*)?(\d{1,2})\s*月\s*(\d{1,2})\s*日', text)
    date = f"{m.group(1)}月{m.group(2)}日" if m else None

    # -------- 书名 + 章节（从 list 抓）--------
    book, chapters = extract_book_and_chapter(text)

    # -------- 人名 --------
    status_tail = r'(?:\s*(?:✓|已读|已讀|补|補|补读|己读))+\s*$'
    names: List[str] = []

    for m in re.finditer(r'^\s*\d+\.\s*(.+?)\s*$', text, flags=re.M):
        item = m.group(1).strip()
        item = re.sub(status_tail, '', item).strip()
        item = re.sub(r'^\+\s*', '', item).strip()
        if item and not item.startswith('#'):
            names.append(item)
    names = sorted(names)

    return {
        "date": date,
        "book": book,
        "chapters": chapters,
        "names": names
    }